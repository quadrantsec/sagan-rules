# Sagan windows-misc.rules
# Copyright (c) 2009-2022. Quadrant Information Security <www.quadrantsec.com>
# All rights reserved.
#
# Please submit any custom rules or ideas to sagan-submit@quadrantsec.com or the sagan-sigs mailing list
#
#*************************************************************
#  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
#  following conditions are met:
#
#  * Redistributions of source code must retain the above copyright notice, this list of conditions and the following
#    disclaimer.
#  * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the
#    following disclaimer in the documentation and/or other materials provided with the distribution.
#  * Neither the name of the nor the names of its contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY EXPRESS OR IMPLIED WARRANTIES,
#  INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
#  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
#  SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
#  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
#  USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
#*************************************************************
# Windows based rules. 
# Eventlog to syslog service.  This is what we primarily use.
# http://code.google.com/p/eventlog-to-syslog/

#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Detection of net listening application [0/5]"; event_id: 5154,861; threshold: type suppress, track by_src, count 5, seconds 300; classtype: network-event; program: *Security*; sid: 5000306; rev:10;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Privileged Service Called"; event_id: 4673,577; classtype: successful-admin; program: *Security*; sid: 5000307; rev:9;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Apple Bonjour service detect [iTunes installed?]"; classtype: policy-violation; program: Bonjour; sid: 5000308; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Application error"; content: " 1001|3a| "; classtype: program-error; program: Application; sid: 5000309; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Application hang"; content: " 1002|3a| "; classtype: program-error; program: Application; sid: 5000310; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Application popup"; content: " 333|3a| "; classtype: program-error; program: Application; sid: 5000311; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] SCSI bug fault occurred"; content: "SCSI bus fault"; classtype: hardware-event; program: CPQCISSE; sid: 5000316; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Backup Exec - Job completed with exceptions"; content: " 57755|3a| "; classtype: program-error; program: Backup; sid: 5000312; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Backup Exec - Job cancellation"; content: " 34114|3a| "; classtype: program-error; program: Backup; sid: 5000313; rev:4;) 
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Backup Exec - Alert - insert media"; content: " 58061|3a| "; classtype: hardware-event; program: Backup; sid: 5000314; rev:4;) 
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Backup Exec - Service started"; content: " 57996|3a| "; classtype: system-event; program: Backup; sid: 5000315; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Citrix message"; classtype: system-event; program: Citrix; sid: 5000317; rev:3;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Trusted Platform Module [TPM] Error.  User name not found"; content: " 17150|3a| "; classtype: unsuccessful-user; program: DAC; sid: 5000318; rev:4;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Eventlog service was corrupted"; content: "was corrupted"; classtype: program-error; program: Eventlog; sid: 5000319; rev:2;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Eventlog service was stopped"; content: "Service Stopped"; classtype: system-event; program: Eventlog; sid: 5000320; rev:3;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Eventlog service returned error"; content: "returned error"; classtype: program-error; program: Eventlog; sid: 5000322; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Eventlog service reporting uptime [in seconds]"; content: "The system uptime"; classtype: not-suspicious; program: Eventlog; sid: 5000323; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] IPSec message"; classtype: not-suspicious; program: IPSec; sid: 5000324; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] LSASRV - Could not establish a secure connection"; content: " 40961|3a| "; classtype: network-event; program: LSASRV; sid: 5000381; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET $MSSQL_PORT (msg: "[WINDOWS-MISC] MS-SQL - Server started"; content: "Microsoft SQL Server"; classtype: system-event; program: MSSQLSERVER; sid: 5000325; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET $MSSQL_PORT (msg: "[WINDOWS-MISC] MS-SQL - Server listening on network"; content: "SQL server listening"; classtype: network-event; program: MSSQLSERVER; parse_src_ip: 1; parse_port; sid: 5000326; rev:6;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] MsiInstaller - Client successfully installed software"; content: "installed successfully"; nocase; classtype: not-suspicious; program: MsiInstaller; sid: 5000327; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] MsiInstaller - Google Toolbar installed"; content: "Google Toolbar"; content: "installed successfully"; nocase; classtype: policy-violation; program: MsiInstaller; sid: 5000328; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] MsiInstaller - Google Toolbar updated"; content: "Google Toolbar"; content: "Update"; nocase; classtype: policy-violation; program: MsiInstaller; sid: 5000329; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] MsiInstaller - Google Toolbar updated"; content: "Google Update Helper"; content: "Update"; nocase; classtype: policy-violation; program: MsiInstaller; sid: 5000331; rev:2;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] MsiInstaller - RegWork - Registry clearner"; content: "RegWork"; content: "Product"; classtype: policy-violation; program: MsiInstaller; sid: 5000330; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] MsiInstaller - Client successfully updated software"; content: "Update"; nocase; classtype: not-suspicious; program: MsiInstaller; sid: 5000332; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] NtServicePack messsage - package or hotfix installed"; content: "was installed"; classtype: not-suspicious; program: NtServicePack; sid: 5000334; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] SNMP Service has started successfully"; content: " 1001|3a| "; classtype: system-event; program: SNMP; sid: 5000335; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Google Software Updater service is active"; content: "Google Software Updater service"; classtype: policy-violation; program: Service; sid: 5000336; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Google update service is active"; content: "Google Update Service"; classtype: policy-violation; program: Service; sid: 5000337; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Google update service is active"; content: "Google Update Service"; classtype: policy-violation; program: Service; sid: 5000338; rev:2;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Tenable Nessus service is active [pen-test tool]"; content: "Tenable Nessus"; classtype: policy-violation; program: Service; sid: 5000339; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Remote Access Connection Manager service is active"; content: "Remote Access Connection Manager"; classtype: network-event; program: Service; sid: 5000340; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Bonjour service is active [iTunes installed?]"; content: "Bonjour"; classtype: policy-violation; program: Service; sid: 5000382; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Symantec AntiVirus startup successful"; content: "startup was successful"; classtype: system-event; program: Symantec; sid: 5000341; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Symantec AntiVirus couldn't scan some files or directories"; content: "Could not scan"; classtype: program-error; program: Symantec; sid: 5000342; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Symantec AntiVirus New virus definition file loaded"; content: "New virus definition file loaded"; classtype: not-suspicious; program: Symantec; sid: 5000343; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Symantec AntiVirus Successful remote connect by administrator"; content: "with Admin role"; content: "User"; content: "connected from"; classtype: successful-admin; program: Symantec; sid: 5000344; rev:3;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Tenable Nessus started [pen-test tool]"; content: "started successfully"; classtype: suspicious-traffic; program: Tenable; sid: 5000345; rev:2;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinRM [Windows Remote Management] is started and listening"; content: " 10148|3a| "; classtype: network-event; program: WinRM; sid: 5000346; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinVNC4 Connection accepted"; content: "Connections"; content: "accepted"; default_proto: tcp; default_dst_port: 5900; classtype: network-event; program: WinVNC4; parse_src_ip: 1; parse_port; sid: 5000347; rev:5;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinVNC4 Connection closed - Requested security type not available"; content: "Requested security type not available"; content: "closed"; default_proto: tcp; default_dst_port: 5900; classtype: suspicious-traffic; program: WinVNC4; parse_src_ip: 1; parse_port; sid: 5000348; rev:5;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinVNC4 Connection blacklisted"; content: "blacklisted"; content: "Connections"; default_proto: tcp; default_dst_port: 5900; classtype: suspicious-traffic; parse_src_ip: 1; parse_port; program: WinVNC4; sid: 5000349; rev:5;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinVNC4 Connection Authentication failure"; content: "Authentication failure"; default_proto: tcp; default_dst_port: 5900; classtype: unsuccessful-user; program: WinVNC4; parse_src_ip: 1; parse_port; sid: 5000350; rev:6;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinVNC4 Connection close - reset by peer"; content: "Connection reset by peer"; content: "closed"; parse_src_ip: 1; parse_port; default_proto: tcp; default_dst_port: 5900; classtype: not-suspicious; program: WinVNC4; sid: 5000351; rev:6;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinVNC4 Connection close - reset by peer [Non-shared]"; content: "Non-shared connection requested"; content: "closed"; parse_src_ip: 1; parse_port; default_proto: tcp; default_dst_port: 5900; classtype: suspicious-traffic; program: WinVNC4; sid: 5000352; rev:5;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinVNC4 Connection close - reading version failed"; content: "reading version failed"; content: "closed"; parse_src_ip: 1; parse_port; default_proto: tcp; default_dst_port: 5900; classtype: suspicious-traffic; program: WinVNC4; sid: 5000353; rev:6;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinVNC4 Connection closed"; content: "Clean disconnection"; content: "closed"; parse_src_ip: 1; parse_port; default_proto: tcp; default_dst_port: 5900; classtype: not-suspicious; program: WinVNC4; sid: 5000354; rev:5;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] WinVNC4 HTTPServer event"; content: "HTTPServer"; default_proto: tcp; default_dst_port: 5900; classtype: network-event; program: WinVNC4; parse_src_ip: 1; parse_port; sid: 5000355; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Crypt32 Failed to extract third-party root list"; content: " 4107|3a| "; classtype: program-error; program: crypt32; sid: 5000356; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Disk corruption [0/2]"; content: " 55|3a| "; classtype: hardware-event; program: Ntfs; threshold:suppress, track by_src, count 1, seconds 300; sid: 5001056; rev:5;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] MSSQLServer I/O error"; content: " 823|3a| "; classtype: program-error; program: Ntfs; sid: 5001096; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Application uninstall"; content: " 11724|3a| "; classtype: program-error; program: MsiInstaller; sid: 5001182; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Application install"; content: " 11707|3a| "; classtype: program-error; program: MsiInstaller; sid: 5001183; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Windows is shutting down"; event_id: 4609,513; classtype: program-error; program: *Security*; sid: 5001184; rev:8;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] File system full"; content: " 13570|3a| "; classtype: system-error; program: NtFrs|Ntfs; sid: 5001191; rev:4;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] System time has changed"; event_id: 4616,520; content:!"|3a|\Program Files\VMware\VMware Tools\vmtoolsd.exe"; classtype: system-event; program: *Security*; sid: 5001194; rev:11;)

# DHCP-Server| 1063: There are no IP addresses available for lease in the scope or superscope "VLAN_311_Example".
# DHCP-Server| 1020: Scope, 10.100.1.0, is 97 percent full with only 2 IP addresses remaining.

#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] DHCP Scope is almost full"; content: " 1020|3a| "; classtype: program-error; program: DHCP-Server; threshold: type suppress, track by_src, count 1, seconds 900; sid: 5001649; rev:4;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] DHCP Scope is FULL";  content: "100 percent full"; content: " 1020|3a| "; classtype: program-error; program: DHCP-Server; threshold: type suppress, track by_src, count 1, seconds 900; sid: 5001716; rev:5;)

# BAD RULE BELOW
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] DHCP Scope if full.  No IP addresses left"; content: " 5001650|3a| "; classtype: network-event; program: DHCP-Server; sid: 5001650; rev:3;)

#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Windows audit log was cleared"; event_id: 1102,517; content: "audit log was cleared"; classtype: system-event; program: *Security*|Eventlog; sid: 5001185; rev:10;)

# Brian Echeverry - 05/07/2015
# SID 5002272 and 5002273 are noisy. 
 
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS] A directory service object was modified"; content: " 5136|3a| "; classtype: configuration-change; program: *Security*; sid:5002272; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS] A directory service object was created"; content: " 5137|3a| "; classtype: configuration-change; program: *Security*; sid:5002273; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS] A directory service object was undeleted"; content: " 5138|3a| "; classtype: configuration-change; program: *Security*; sid:5002274; rev:3;)
#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS] A directory service object was moved"; content: " 5139|3a| "; classtype: configuration-change; program: *Security*; sid:5002275; rev:3;)


alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[WINDOWS-MISC] System shutdown [XBIT SET]"; event_id: 1074,6006,41,6008,1076; program: *System*|*USER32*; flexbits: set,reboot.windows,3600; flexbits:noeve; classtype: system-event; sid: 5002014; rev:31;)

# Added by Brian Echeverry (09/22/2015)

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Microsoft Antimalware has encountered an error trying to update signatures"; program: *Microsoft_Antimalware*; event_id: 2001; threshold: type suppress, track by_src, count 1, seconds 86400; classtype: program-error; sid:5002392; rev:5;)

# Rules added by Brian Echeverry ( becheverry@quadrantsec.com) - 10/21/2015

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Unable to log events to security log"; event_id: 521; threshold: type suppress, track by_src, count 1, seconds 86400; classtype: program-error; program: *Security*; sid:5002564; rev:5;)

# Added by Champ Clark III (04/20/2016) - Great read at http://pastebin.com/raw/0SNSvyjJ

#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Installation of service via SCM"; event_id: 7045; content:!"ForeScout"; nocase; content:!"nxlog"; nocase; content:!"ccmsetup"; nocase; classtype: suspicious-traffic; program: System|Service_Control_Manager; reference: url,pastebin.com/raw/0SNSvyjJ; sid:5002817; rev:5;)

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Installation of new service via Security Audit "; json_map:"message",".Message"; json_map:"event_id",".EventID"; event_id: 4697,601; content:!"dllhost.exe /Processid|3a|"; content:!"Program Files"; nocase; meta_content:!"%sagan%",Microsoft,MpEngineStore,CredentialenrollmentManager,CrowdStrike,VeeamGuestHelper.exe,|2e|sys,ManageEngine,VM3DService,McAfee,AdminArsenal,vmvss,bomgar; meta_nocase; meta_content:"Service Type|3a| %sagan% ",0x1,0x2,0x10,0x20; meta_content:"Service Start Type|3a| %sagan% ",2,3; meta_nocase; classtype: suspicious-traffic; program:*Security*; reference: url,learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4697; sid:5002818; rev:7;)
alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] VSS shutdown [XBIT SET]"; event_id: 8225; flexbits: set,vss_shutdown,1200; flexbits:noeve; classtype: program-error; program: *Application*; sid:5005745; rev:2;)

# Added by Champ Clark III (08/19/2016) 

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Suspicious event logging service shutdown."; event_id: 1100; flexbits: isnotset,by_src,reboot.windows; flexbits: isnotset,by_src,nxlog_shutdown; flexbits: isnotset,by_src,vss_shutdown; flexbits_pause: 1200; classtype: suspicious-traffic; program: *Security*; sid:5002941; rev:11;)

# Added by Champ Clark III (09/01/2016)
# These target strange errors seen by evtsys.  

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Event log has been cleared."; event_id: 104; content: "cleared"; classtype: suspicious-traffic; program: *Eventlog*; sid:5002954; rev:4;)

#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Logging has been stopped on this device"; event_id: 570; content: "callback"; classtype: suspicious-traffic; program: The; sid:5002955; rev:4;)

#alert any $HOME_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Fan failure detected"; content:" 10|3a| Fan "; content:" has failed"; classtype: hardware-event; program: System; sid:5003040; rev:2;)

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Installation of PSEXEC service via Security Audit "; meta_content:"%sagan%",psexesvc,psexec; meta_nocase; meta_content:!"%sagan%",ForeScout,nxlog,ccmsetup; event_id:7045,4697,601; classtype: suspicious-traffic; program: *Security*|System|Service_Control_Manager; reference: url,pastebin.com/raw/0SNSvyjJ; sid:5003105; rev:7;)

#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Installation of PSEXEC service via SCM"; meta_content:"%sagan%",psexesvc,psexec; meta_nocase; content: " 7045|3a| "; content:!"ForeScout"; nocase; content:!"nxlog"; nocase; content:!"ccmsetup"; nocase; classtype: suspicious-traffic; program: System|Service_Control_Manager; reference: url,pastebin.com/raw/0SNSvyjJ; sid:5003106; rev:3;)

#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Potential Kerberoasting Activity Detected - EID 4769 [10/1]"; event_id: 4769; content:"Ticket Options: 0x40810000"; nocase; normalize; after:track by_username, count 500, seconds 600; threshold:type suppress, track by_username, count 1, seconds 3600; classtype:successful-admin; reference:url,adsecurity.org/?p=3458; reference:url,malware.news/t/detection-in-depth/39729; sid:5006529; rev:4; metadata:deployment Server,affected_product NONE,affected_version NONE,mitigation www.blumira.com/active-directory-kerberos-attacks/,deprecation_reason NONE,tag NONE, created_at 2023_01_20, updated_at 2023_04_05, mitre_tactic_id TA0006, mitre_technique_id T1558.003;)         

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Rubeus successful TGT Enumeration"; event_id: 4611; content: "Logon Process Name|3a| User32LogonProcesss"; nocase; classtype:successful-admin; reference: url,posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1;sid:5006530; rev:2;)

#alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Potential Kerberoasting Activity Detected - EID 4768 [10/1]"; event_id:4768; content: !"Ticket Encryption Type|3a| 0x12"; content: !"Ticket Encryption Type|3a| 0xFFFFFFFF"; nocase; content: !"|24|"; after:track by_src, count 10, seconds 60; threshold:type suppress, track by_src, count 1, seconds 3600; classtype:successful-admin; reference:url,redsiege.com/tools-techniques/2020/10/detecting-kerberoasting/; sid:5008394; rev:1;)

alert any $HOME_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Pass the Hash Detected"; json_map:"message",".Message"; event_id:4624; content:!"Account Name: SYSTEM"; content:!"Network Account Name: netwrix-svc"; content:"Logon Type: 9"; content:"Logon Process: seclogo"; content:"Authentication Package: Negotiate"; classtype:trojan-activity; reference:url,thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/; reference:url,blog.netwrix.com/2021/11/30/how-to-detect-pass-the-hash-attacks/; sid:5008395; rev:3;)

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Potential AS-REP Roasting Activity Detected - EID 4768"; event_id:4768; content:"Ticket Options|3a| 0x40800010"; content:"Ticket Encryption Type|3a| 0x17"; content: !"|24|"; content:"Pre-Authentication Type|3a| 0"; classtype:successful-admin; reference:url,https://blog.certcube.com/as-rep-roasting-attack/; sid:5008406; rev:2;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Veeam PoC Defaults (CVE-2022-26500)"; content:!"\VeeamRecovery\"; nocase; meta_content:"%sagan%",|5c|VeeamDeploymentDll.dll,|5c|poc.dll; meta_nocase; reference:url,defense.one/d/36-cve-2022-26500-cve-2022-26501-veeam-rce-analysis; classtype:trojan-activity; sid:5010735; rev:3;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Response to exploit attempt (CVE-2022-26500)"; content:"<RIResponse"; content:"PersistentConnection="; content:"RemotePath="; reference:url,defense.one/d/36-cve-2022-26500-cve-2022-26501-veeam-rce-analysis; classtype:trojan-activity; sid:5010736; rev:1;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Possible Local PrivEsc (CVE-2022-26503)"; content:"127.0.0.1:9395/VeeamService"; nocase; reference:url,defense.one/d/36-cve-2022-26500-cve-2022-26501-veeam-rce-analysis; classtype:trojan-activity; sid:5010737; rev:1;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Command line options used by ExploitRemotingService"; program:*Security*|*Sysmon*; event_id:1,4688; meta_content:"%sagan%",-usecom,-useser,-uselease,-autodir; reference:cve,2022-26503; reference:url,github.com/tyranid/ExploitRemotingService; classtype:trojan-activity; sid:5010738; rev:1;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Possible Powershell useage via IPSInvokerService"; meta_content:"%sagan%",IPSInvokerService,CpsInvokerService; meta_nocase; reference:cve,2022-26504; reference:url,defense.one/d/36-cve-2022-26500-cve-2022-26501-veeam-rce-analysis; classtype:trojan-activity; sid:5010739; rev:1;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Possible Exploitation of CVE-2022-26504"; content:"|3a|8732/InvokerWrapperService"; nocase; reference:cve,2022-26504; reference:url,defense.one/d/36-cve-2022-26500-cve-2022-26501-veeam-rce-analysis; classtype:trojan-activity; sid:5010740; rev:1;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Possible Exploitation of CVE-2022-26504"; content:"servervmm.sinsinology.local"; nocase; reference:cve,2022-26504; reference:url,defense.one/d/36-cve-2022-26500-cve-2022-26501-veeam-rce-analysis; classtype:trojan-activity; sid:5010741; rev:1;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] OWASSRF in Exchange for RCE"; program:*Security*|*Sysmon*; event_id:1,4688; content:"\powershell.exe"; content:"\w3wp.exe"; distance:0; reference:cve,2022-41080; reference:cve,2022-41082; reference:url,www.rapid7.com/blog/post/2022/12/21/cve-2022-41080-cve-2022-41082-rapid7-observed-exploitation-of-owassrf-in-exchange-for-rce/; classtype:trojan-activity; sid:5010904; rev:1;)

#Added by Bryant Smith 14 June 2023
alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] moveitdmz pool command (CVE-2023-34362)"; program:*Sysmon*|*Security*; event_id:1,4688; content:"w3wp.exe"; content:"moveitdmz pool"; reference:cve,2023-34362; reference:url,www.huntress.com/blog/moveit-transfer-critical-vulnerability-rapid-response; classtype:trojan-activity; sid:5013537; rev:1; metadata:deployment Server,affected_product MOVEit,affected_version 13.0.6,mitigation https://community.progress.com/s/article/MOVEit-Transfer-Critical-Vulnerability-31May2023,deprecation_reason NONE,tag NONE, created_at 2023_06_12, updated_at 2023_06_12, mitre_tactic_id TA0011, mitre_technique_id T1071;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] POST to machine2.aspx (CVE-2023-34362)"; program:*IIS*|*Exchange*; content:"POST"; content:"/machine2.aspx"; nocase; reference:cve,2023-34362; reference:url,www.huntress.com/blog/moveit-transfer-critical-vulnerability-rapid-response; classtype:trojan-activity; sid:5013538; rev:1; metadata:deployment Server,affected_product MOVEit,affected_version 13.0.6,mitigation https://community.progress.com/s/article/MOVEit-Transfer-Critical-Vulnerability-31May2023,deprecation_reason NONE,tag NONE, created_at 2023_06_12, updated_at 2023_06_12, mitre_tactic_id TA0001, mitre_technique_id T1190;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] POST to /moveitisapi/moveitisapi.dll (CVE-2023-34362)"; program:*IIS*|*Exchange*; content:"POST"; content:"/moveitisapi/moveitisapi.dll"; nocase; content:"action=m2"; nocase; reference:cve,2023-34362; reference:url,www.huntress.com/blog/moveit-transfer-critical-vulnerability-rapid-response; classtype:trojan-activity; sid:5013539; rev:1; metadata:deployment Server,affected_product MOVEit,affected_version 13.0.6,mitigation https://community.progress.com/s/article/MOVEit-Transfer-Critical-Vulnerability-31May2023,deprecation_reason NONE,tag NONE, created_at 2023_06_12, updated_at 2023_06_12, mitre_tactic_id TA0001, mitre_technique_id T1190;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] POST to /guestaccess.aspx (CVE-2023-34362)"; program:*IIS*|*Exchange*; content:"POST"; content:"/guestaccess.aspx"; nocase; reference:cve,2023-34362; reference:url,www.huntress.com/blog/moveit-transfer-critical-vulnerability-rapid-response; classtype:trojan-activity; sid:5013540; rev:1; metadata:deployment Server,affected_product MOVEit,affected_version 13.0.6,mitigation https://community.progress.com/s/article/MOVEit-Transfer-Critical-Vulnerability-31May2023,deprecation_reason NONE,tag NONE, created_at 2023_06_12, updated_at 2023_06_12, mitre_tactic_id TA0001, mitre_technique_id T1190;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] POST to /guestaccess.aspx with parameters (CVE-2023-34362)"; program:*IIS*|*Exchange*; content:"POST"; content:"/guestaccess.aspx"; nocase; content:"Transaction=dummy"; nocase; content:"Arg06=accesscode"; nocase; content:"Arg12=promptaccesscode"; nocase; reference:cve,2023-34362; reference:url,attackerkb.com/topics/mXmV0YpC3W/cve-2023-34362/rapid7-analysis; classtype:trojan-activity; sid:5013541; rev:1; metadata:deployment Server,affected_product MOVEit,affected_version 13.0.6,mitigation https://community.progress.com/s/article/MOVEit-Transfer-Critical-Vulnerability-31May2023,deprecation_reason NONE,tag NONE, created_at 2023_06_12, updated_at 2023_06_12, mitre_tactic_id TA0001, mitre_technique_id T1190;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] File Upload (CVE-2023-34362)"; program:*IIS*|*Exchange*; content:"PUT"; content:"/api/v1/folders/"; nocase; content:"uploadType=resumable&fileId="; reference:cve,2023-34362; reference:url,www.huntress.com/blog/moveit-transfer-critical-vulnerability-rapid-response; classtype:trojan-activity; sid:5013542; rev:1; metadata:deployment Server,affected_product MOVEit,affected_version 13.0.6,mitigation https://community.progress.com/s/article/MOVEit-Transfer-Critical-Vulnerability-31May2023,deprecation_reason NONE,tag NONE, created_at 2023_06_12, updated_at 2023_06_12, mitre_tactic_id TA0001, mitre_technique_id T1190;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] GET /human2.aspx (CVE-2023-34362)"; program:*IIS*|*Exchange*; content:"GET"; content:"/human2.aspx"; nocase; reference:cve,2023-34362; reference:url,www.huntress.com/blog/moveit-transfer-critical-vulnerability-rapid-response; classtype:trojan-activity; sid:5013543; rev:1; metadata:deployment Server,affected_product MOVEit,affected_version 13.0.6,mitigation https://community.progress.com/s/article/MOVEit-Transfer-Critical-Vulnerability-31May2023,deprecation_reason NONE,tag NONE, created_at 2023_06_12, updated_at 2023_06_12, mitre_tactic_id TA0001, mitre_technique_id T1190;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-FIREWALL] Firewall rule added by AnyDesk"; program:*Firewall*; json_map:"message",".Message"; json_map:"event_id",".EventID"; event_id:2004; content:"Rule Name|3a| AnyDesk"; nocase; classtype:system-event; sid:5013559; rev:1; metadata:deployment Server,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_07_05, updated_at 2023_07_05, mitre_tactic_id TA0011, mitre_technique_id T1219;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-TERMINAL-SERVICES] RDP connection to loopback"; program:*Terminal*; json_map:"message",".Message"; json_map:"event_id",".EventID"; event_id:1149; content:"Source Network Address|3a| 127.0.0.1"; classtype:trojan-activity; sid:5013567; rev:1; metadata:deployment Server,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_07_05, updated_at 2023_07_05, mitre_tactic_id TA0008, mitre_technique_id T1021.001;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-SYSTEM] The Setup Log was cleared"; program:*System*; json_map:"message",".Message"; json_map:"event_id",".EventID"; event_id:104; content:"The Setup log file was cleared"; classtype:trojan-activity; sid:5013575; rev:1; metadata:deployment Server,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_07_05, updated_at 2023_07_05, mitre_tactic_id TA0005, mitre_technique_id T1070.001;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-SYSTEM] The System log file was cleared"; program:*System*; json_map:"message",".Message"; json_map:"event_id",".EventID"; event_id:104; content:"The System log file was cleared"; classtype:trojan-activity; sid:5013576; rev:1; metadata:deployment Server,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_07_05, updated_at 2023_07_05, mitre_tactic_id TA0005, mitre_technique_id T1070.001;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-SYSTEM] The Application log file was cleared"; program:*System*; json_map:"message",".Message"; json_map:"event_id",".EventID"; event_id:104; content:"The Application log file was cleared"; classtype:trojan-activity; sid:5013577; rev:1; metadata:deployment Server,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_07_05, updated_at 2023_07_05, mitre_tactic_id TA0005, mitre_technique_id T1070.001;)

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] Installation of new service via Security Audit "; json_map:"message",".Message"; json_map:"event_id",".EventID"; event_id:7045; meta_content:!"%sagan%",Microsoft,MpEngineStore,CredentialenrollmentManager,CrowdStrike,Program|20|Files,VeemGuestHelper.exe,.sys,VM3DService,McAfee,AdminArsenal,vmvss,bomgar; meta_nocase; content:"Service Type|3a| user mode"; meta_content:"Service Start Type|3a| %sagan% start",auto,demand; meta_nocase; classtype: suspicious-traffic; program:*Security*; reference: url,learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4697; sid:5013682; rev:2;)

alert any $EXTERNAL_NET any -> $HOME_NET any (msg: "[WINDOWS-MISC] A service was installed in the system with suspicious programs"; json_map:"message",".Message"; json_map:"event_id",".EventID"; event_id:7045,4697; content:!"\Microsoft\"; nocase; meta_content:"%sagan%",|5c|ADMIN$,|5c|C$,|5c|IPC$,cmd|20 2f|c,powershell,pwsh,comspec,screenconnect,SystemDrive,teamviewer,psexesvc,psexec,rundll32.exe,regsvr32.exe,cscript.exe,regsvcs.exe,wmic.exe,anydesk,logmein,ultravnc; meta_nocase; classtype: suspicious-traffic; program:*Security*; reference: url,learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4697; reference:url,www.socinvestigation.com/hunting-for-suspicious-windows-services-mind-map/; sid:5013683; rev:2;)

#Added 12 October 2023
#alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] A scheduled task was registered"; program:*TaskScheduler*; event_id:106; content:"registered Task Scheduler"; meta_content:!"|5c|%sagan%",Microsoft,Lenovo,OneDrive,User_Feed_Synchronization,SensorFramework-LogonTask; reference:url,redcanary.com/threat-detection-report/techniques/scheduled-task/; reference:url,thedfirreport.com/2023/02/06/collect-exfiltrate-sleep-repeat/; classtype:trojan-activity; sid:5013818; rev:2; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_02_21, updated_at 2023_04_25, mitre_tactic_id TA0003, mitre_technique_id T1053.005;)
#alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] A scheduled task was updated"; program:*TaskScheduler*; event_id:140; meta_content:!"%sagan%",UpdateOrchestrator,QueueReporting,WindowsUpdate,SoftwareProtectionPlatform,.NET Framework; content:"updated Task Scheduler"; nocase; reference:url,redcanary.com/threat-detection-report/techniques/scheduled-task/; reference:url,thedfirreport.com/2023/02/06/collect-exfiltrate-sleep-repeat/; classtype:trojan-activity; sid:5013819; rev:3; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_02_21, updated_at 2023_05_03, mitre_tactic_id TA0003, mitre_technique_id T1053.005;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] NetLogon event with mimikatz string (ZeroLogon)"; program:*System*; event_id:5805; content:"mimikatz"; reference:url,thedfirreport.com/2022/11/28/emotet-strikes-again-lnk-file-leads-to-domain-wide-ransomware/; classtype:trojan-activity; sid:5013825; rev:1; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_02_01, updated_at 2023_02_01, mitre_tactic_id TA0004, mitre_technique_id T1588.002;)
#alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] ISO File Mounted"; program:*VHDMP*; event_id:1; content:".iso has come online"; nocase; reference:url,thedfirreport.com/2023/01/09/unwrapping-ursnifs-gifts/; classtype:trojan-activity; sid:5013837; rev:1; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_02_01, updated_at 2023_02_01, mitre_tactic_id TA0005, mitre_technique_id T1553.005;)
#alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] ISO File Mounted"; program:*VHDMP*; event_id:12; content:"created successfully"; nocase; content:"Type = ISO"; reference:url,thedfirreport.com/2023/01/09/unwrapping-ursnifs-gifts/; classtype:trojan-activity; sid:5013838; rev:1; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_02_01, updated_at 2023_02_01, mitre_tactic_id TA0005, mitre_technique_id T1553.005;)
#alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Windows Defender status change to SNOOZED"; program:Application; event_id:15; content:"SECURITY_PRODUCT_STATE_SNOOZED"; reference:url,app.any.run/tasks/95f2e73d-2767-4f87-8e97-825d10b4665c/; classtype:trojan-activity; sid:5013853; rev:1; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_04_27, updated_at 2023_04_27, mitre_tactic_id TA0005, mitre_technique_id T1562.001;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] ProcDump64 Installed as a Service"; program:*System*|*Service*; event_id:7045; content:"Service File Name:"; content:"prodump64"; nocase; distance:0; reference:url,thedfirreport.com/2022/09/26/bumblebee-round-two/; classtype:trojan-activity; sid:5013868; rev:1; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_02_02, updated_at 2023_02_02, mitre_tactic_id TA0006, mitre_technique_id T1003.001;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Possible ProcDump64 Installed as a Service"; program:*System*|*Service*; event_id:7045; content:"Service File Name:"; meta_content:"%sagan%",-accepteula,-ma,-am; meta_nocase; content:"lsass.exe";  reference:url,thedfirreport.com/2022/09/26/bumblebee-round-two/; classtype:trojan-activity; sid:5013869; rev:1; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_02_02, updated_at 2023_02_02, mitre_tactic_id TA0006, mitre_technique_id T1003.001;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Suspicious Service Installed"; program:*System*; event_id:7045; content:"cmd.exe /c rundll32.exe c:\programdata\"; nocase; reference:url,thedfirreport.com/2022/11/28/emotet-strikes-again-lnk-file-leads-to-domain-wide-ransomware/; classtype:trojan-activity; sid:5013919; rev:1; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_02_01, updated_at 2023_02_01, mitre_tactic_id TA0008, mitre_technique_id T1071;)
#alert any $HOME_NET any -> $HOME_NET any (msg:"[WINDOWS-MISC] Remote Desktop Service - Administrator Logon"; program:*TerminalServices*; event_id:21; content:"\Administrator"; reference:url,thedfirreport.com/2022/09/26/bumblebee-round-two/; classtype:trojan-activity; sid:5013922; rev:1; metadata:deployment Endpoint,affected_product NONE,affected_version NONE,mitigation NONE,deprecation_reason NONE,tag NONE, created_at 2023_02_02, updated_at 2023_02_02, mitre_tactic_id TA0008, mitre_technique_id T1021.001;)

